<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Booru Tag Extractor (Gelbooru + Danbooru)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: #eee; }
        .container { margin-top: 20px; max-width: 800px; }
        textarea { width: 100%; height: 400px; background: #222; color: #eee; border: 1px solid #444; padding: 12px; font-size: 15px; line-height: 1.5; resize: vertical; }
        button { margin: 15px 10px 0 0; padding: 12px 28px; cursor: pointer; background: #555; color: white; border: none; border-radius: 4px; font-size: 16px; }
        button:hover { background: #777; }
        input { padding: 12px; width: 500px; max-width: 90%; background: #222; color: #eee; border: 1px solid #444; margin: 10px 0; display: block; font-size: 15px; }
        #status { color: #ffcc00; font-weight: bold; margin-top: 15px; font-size: 16px; }
        p.note { color: #aaa; font-size: 14px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h2>Booru Tag Extractor (Gelbooru + Danbooru)</h2>
    <p class="note">Pega URL de Gelbooru o Danbooru → extrae tags separados por coma → edita si quieres → guarda en .txt</p>

    <input type="text" id="url" placeholder="URL del post (Gelbooru o Danbooru, ej: https://danbooru.donmai.us/posts/123456 o Gelbooru id=...)">
    <input type="text" id="filename" placeholder="Nombre base (ej: 01dan → genera 01dan.txt)">

    <button onclick="loadPost()">Cargar Tags</button>

    <div id="container" class="container" style="display:none;">
        <textarea id="tagsArea" placeholder="Los tags aparecerán aquí separados por coma... puedes editarlos"></textarea>
        <br>
        <button onclick="saveTags()">Guardar TXT</button>
    </div>

    <p id="status"></p>

    <script>
    async function loadPost() {
        const url = document.getElementById("url").value.trim();
        const baseName = document.getElementById("filename").value.trim();
        const status = document.getElementById("status");

        if (!url || !baseName) {
            alert("Completa la URL y el nombre base por favor");
            return;
        }

        let site = "Desconocido";
        if (url.includes("gelbooru.com")) site = "Gelbooru";
        else if (url.includes("danbooru.donmai.us")) site = "Danbooru";
        else {
            alert("La URL debe ser de Gelbooru o Danbooru");
            return;
        }

        status.innerText = `Cargando tags desde ${site}...`;

        const proxyURL = "https://corsproxy.io/?" + encodeURIComponent(url);

        try {
            const response = await fetch(proxyURL);
            if (!response.ok) {
                throw new Error(`No se pudo cargar (${response.status})`);
            }

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // Selectores comunes para ambos sitios
            const tags = new Set();
            doc.querySelectorAll(
                ".tag-type-general a, .tag-type-character a, .tag-type-copyright a, " +
                ".tag-type-artist a, .tag-type-metadata a, .tag-type-general.tag a, " +
                ".search-tag a, .tag a"
            ).forEach(a => {
                let t = a.textContent.trim();
                if (t) {
                    t = t.replace(/_/g, " ");
                    tags.add(t);
                }
            });

            const tagsText = Array.from(tags).join(", ");
            document.getElementById("tagsArea").value = tagsText || `(No se encontraron tags en ${site})`;

            document.getElementById("container").style.display = "block";

            window.currentBaseName = baseName;

            status.innerText = `¡Tags de ${site} cargados! Edita si quieres y guarda.`;
        } catch (err) {
            console.error(err);
            status.innerText = "Error: " + err.message;
            alert("Error: " + err.message + "\nRevisa consola (F12) si persiste.");
        }
    }

    function saveTags() {
        const tags = document.getElementById("tagsArea").value.trim();
        const baseName = window.currentBaseName;

        if (!tags || !baseName) {
            alert("Carga un post primero");
            return;
        }

        const blob = new Blob([tags], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${baseName}.txt`;
        link.click();
    }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Booru Tag Extractor - Multi Posts</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: #eee; }
        .container { margin-top: 20px; max-width: 900px; margin-bottom: 80px; } /* ← margen inferior grande para que no pegue al fondo */
        textarea { 
            width: 100%; 
            height: 450px; 
            background: #222; 
            color: #eee; 
            border: 1px solid #444; 
            padding: 12px; 
            font-size: 15px; 
            line-height: 1.6; 
            resize: vertical; 
            margin-bottom: 40px; /* ← margen extra debajo de la textarea */
        }
        button { margin: 12px 10px 0 0; padding: 10px 22px; cursor: pointer; background: #555; color: white; border: none; border-radius: 4px; font-size: 15px; }
        button:hover { background: #777; }
        .url-group { display: flex; align-items: center; margin: 10px 0; gap: 10px; flex-wrap: wrap; }
        .url-group input[type="text"] { flex: 1; padding: 10px; background: #222; color: #eee; border: 1px solid #444; font-size: 14px; min-width: 300px; }
        .url-group input[type="text"]:nth-child(2) { width: 140px; flex: none; }
        #status { color: #ffcc00; font-weight: bold; margin-top: 15px; font-size: 16px; }
        p.note { color: #aaa; font-size: 14px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h2>Booru Tag Extractor (Gelbooru + Danbooru)</h2>
    <p class="note">Pega varias URLs (Gelbooru o Danbooru) + nombre base → tags separados por ///// → guarda en un solo .txt</p>

    <div id="urlsContainer">
        <div class="url-group">
            <input type="text" class="url-input" placeholder="URL del post (Gelbooru o Danbooru)">
            <input type="text" class="name-input" placeholder="Nombre base (ej: 01)">
            <button onclick="removeRow(this)">-</button>
        </div>
    </div>

    <button onclick="addRow()">+ Agregar otra URL</button>
    <button onclick="loadAllPosts()">Cargar Todos los Tags</button>

    <div id="container" style="display:none; margin-top: 25px;">
        <textarea id="tagsArea" placeholder="Los tags de cada post aparecerán aquí separados por /////..."></textarea>
        <br>
        <button onclick="saveAllTags()">Guardar TXT (todos juntos)</button>
    </div>

    <p id="status"></p>

    <script>
    let rowCount = 1;

    function addRow() {
        if (rowCount >= 10) {
            alert("Máximo 10 posts por carga");
            return;
        }
        const container = document.getElementById("urlsContainer");
        const div = document.createElement("div");
        div.className = "url-group";
        div.innerHTML = `
            <input type="text" class="url-input" placeholder="URL del post">
            <input type="text" class="name-input" placeholder="Nombre base (ej: 02)">
            <button onclick="removeRow(this)">-</button>
        `;
        container.appendChild(div);
        rowCount++;
    }

    function removeRow(btn) {
        if (rowCount <= 1) return;
        btn.parentElement.remove();
        rowCount--;
    }

    async function loadAllPosts() {
        const status = document.getElementById("status");
        status.innerText = "Procesando posts... (puede tardar)";

        const urlGroups = document.querySelectorAll(".url-group");
        let allResults = [];

        for (const group of urlGroups) {
            const url = group.querySelector(".url-input").value.trim();
            const baseName = group.querySelector(".name-input").value.trim();

            if (!url) continue;

            let site = "Desconocido";
            if (url.includes("gelbooru.com")) site = "Gelbooru";
            else if (url.includes("danbooru.donmai.us")) site = "Danbooru";
            else {
                allResults.push(`[URL inválida] ${url} (solo Gelbooru o Danbooru)\n/////`);
                continue;
            }

            const proxyURL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

            try {
                const response = await fetch(proxyURL);
                if (!response.ok) throw new Error(`Status ${response.status}`);

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");

                const tags = new Set();
                doc.querySelectorAll(
                    '[class*="tag-type-"] a, .tag a, .post-tag a, .search-tag a, .tag-list a, a[href^="/posts?tags="], a[href^="/wiki_pages/"]'
                ).forEach(a => {
                    let t = a.textContent.trim();
                    if (t && t.length > 1) {
                        t = t.replace(/_/g, " ");
                        tags.add(t);
                    }
                });

                const tagsText = Array.from(tags).join(", ") || "(sin tags visibles)";
                allResults.push(`${url}  (${site})\n${tagsText}\n/////`);
            } catch (err) {
                allResults.push(`[Error en ${url} (${site})]: ${err.message}\n/////`);
            }
        }

        const finalText = allResults.join("\n\n");
        document.getElementById("tagsArea").value = finalText.trim() || "No se procesó ningún post válido.";

        document.getElementById("container").style.display = "block";
        status.innerText = "¡Listo! Revisa y edita antes de guardar.";
    }

    function saveAllTags() {
        const text = document.getElementById("tagsArea").value.trim();
        if (!text) {
            alert("No hay tags para guardar");
            return;
        }

        const blob = new Blob([text], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "tags_multiples.txt";
        link.click();
    }
    </script>
</body>
</html>
